<script>
    // Configura√ß√£o - SUBSTITUA PELA NOVA URL DE IMPLANTA√á√ÉO GERADA COMO "QUALQUER PESSOA"
    const URL_SCRIPT = 'https://script.google.com/macros/s/AKfycbxFig2mn-5-qt3ArOhrrYjcgOKwrhdKDOqL18YrRm_R0FKuMEZSrP9gxtvtC5nacPpA/exec'; // Ex: https://script.google.com/macros/s/AKfycb.../exec
    
    // Elementos da p√°gina
    const nomeInput = document.getElementById('nome');
    const dataSpan = document.getElementById('data');
    const horaSpan = document.getElementById('hora');
    const localizacaoSpan = document.getElementById('localizacao');
    const registrarBtn = document.getElementById('registrarBtn');
    const mensagemDiv = document.getElementById('mensagem');
    const statusDiv = document.getElementById('status');
    
    let localizacao = null;
    
    // Iniciar aplicativo
    function iniciar() {
        // Carregar nome salvo
        const nomeSalvo = localStorage.getItem('nomeFuncionario');
        if (nomeSalvo) {
            nomeInput.value = nomeSalvo;
        }
        
        // Atualizar rel√≥gio
        atualizarRelogio();
        setInterval(atualizarRelogio, 1000);
        
        // Obter localiza√ß√£o
        obterLocalizacao();
        
        // Configurar bot√£o
        registrarBtn.addEventListener('click', registrarPonto);
        
        statusDiv.textContent = 'Pronto para registrar ponto';
    }
    
    function atualizarRelogio() {
        const agora = new Date();
        dataSpan.textContent = agora.toLocaleDateString('pt-BR');
        horaSpan.textContent = agora.toLocaleTimeString('pt-BR');
    }
    
    function obterLocalizacao() {
        if (!navigator.geolocation) {
            localizacaoSpan.textContent = '‚ùå Geolocaliza√ß√£o n√£o suportada';
            return;
        }
        
        localizacaoSpan.textContent = 'üìç Obtendo localiza√ß√£o...';
        
        navigator.geolocation.getCurrentPosition(
            posicao => {
                localizacao = {
                    lat: posicao.coords.latitude,
                    lng: posicao.coords.longitude
                };
                localizacaoSpan.textContent = `üìç Lat: ${localizacao.lat.toFixed(4)}, Lng: ${localizacao.lng.toFixed(4)}`;
                statusDiv.textContent = 'Localiza√ß√£o obtida - Pronto para registrar';
            },
            erro => {
                console.error('Erro de localiza√ß√£o:', erro);
                localizacaoSpan.textContent = '‚ùå Localiza√ß√£o n√£o dispon√≠vel';
                statusDiv.textContent = 'Aguardando localiza√ß√£o...';
            }
        );
    }
    
    function registrarPonto() {
        const nome = nomeInput.value.trim();
        
        if (!nome) {
            mostrarMensagem('Por favor, digite seu nome', 'erro');
            nomeInput.focus();
            return;
        }
        
        if (!localizacao) {
            mostrarMensagem('Aguardando localiza√ß√£o. Aguarde alguns segundos.', 'erro');
            return;
        }
        
        // Salvar nome
        localStorage.setItem('nomeFuncionario', nome);
        
        // Criar registro
        const agora = new Date();
        const registro = {
            nome: nome,
            data: agora.toLocaleDateString('pt-BR'),
            hora: agora.toLocaleTimeString('pt-BR'),
            latitude: localizacao.lat,
            longitude: localizacao.lng,
            timestamp: agora.getTime()
        };
        
        // Enviar para planilha
        enviarParaPlanilha(registro);
    }
    
    function enviarParaPlanilha(registro) {
        registrarBtn.disabled = true;
        registrarBtn.innerHTML = '<div class="spinner" style="width: 20px; height: 20px; margin: 0 auto;"></div> Enviando...';

        fetch(URL_SCRIPT, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                action: 'registrarPonto',
                data: registro
            })
        })
        .then(response => {
            // Se a resposta for um redirecionamento, seguir para a URL final
            if (response.redirected) {
                return fetch(response.url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        action: 'registrarPonto',
                        data: registro
                    })
                });
            }
            return response;
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Erro na resposta do servidor');
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                mostrarMensagem('Ponto registrado com sucesso no Google Sheets!', 'sucesso');
            } else {
                throw new Error(data.message || 'Erro desconhecido');
            }
        })
        .catch(erro => {
            console.error('Erro ao enviar para Google Sheets:', erro);
            mostrarMensagem('Erro ao registrar ponto: ' + erro.message, 'erro');
            // Salvar localmente em caso de falha (opcional)
            // salvarNoHistoricoLocal(registro);
        })
        .finally(() => {
            registrarBtn.disabled = false;
            registrarBtn.textContent = '‚úÖ Registrar Ponto';
        });
    }
    
    function mostrarMensagem(texto, tipo) {
        mensagemDiv.textContent = texto;
        mensagemDiv.className = `mensagem ${tipo}`;
        mensagemDiv.style.display = 'block';
        
        setTimeout(() => {
            mensagemDiv.style.display = 'none';
        }, 5000);
    }
    
    // Iniciar
    iniciar();
</script>
